<mat-card class="filtros-card">
  <mat-card-header>
    <mat-card-title>Asignación de Descuentos</mat-card-title>
    <mat-card-subtitle>Seleccione filtros para buscar trabajadores</mat-card-subtitle>
  </mat-card-header>
  
  <mat-card-content>
    <form [formGroup]="filtroForm">
      <div class="filtros-container">
        <div class="filtros-fila">
          <!-- Sociedad -->
          <mat-form-field appearance="outline">
            <mat-label>Sociedad</mat-label>
            <mat-select formControlName="sociedad_id">
              <mat-option value="">Todas</mat-option>
              <mat-option *ngFor="let sociedad of sociedades" [value]="sociedad.id">
                {{ sociedad.nombre }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          
          <!-- Cliente -->
          <mat-form-field appearance="outline">
            <mat-label>Cliente</mat-label>
            <mat-select formControlName="cliente_id">
              <mat-option value="">Todos</mat-option>
              <mat-option *ngFor="let cliente of clientes" [value]="cliente.id">
                {{ cliente.nombre }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        
        <div class="filtros-fila">
          <!-- Fundo -->
          <mat-form-field appearance="outline">
            <mat-label>Fundo</mat-label>
            <mat-select formControlName="fundo_id">
              <mat-option value="">Todos</mat-option>
              <mat-option *ngFor="let fundo of fundos" [value]="fundo.id">
                {{ fundo.nombre_campo }}
              </mat-option>
            </mat-select>
            <mat-hint *ngIf="cargandoFundos">Cargando fundos...</mat-hint>
            <mat-hint *ngIf="!filtroForm.get('cliente_id')?.value && !cargandoFundos">
              Seleccione un cliente primero
            </mat-hint>
          </mat-form-field>
          
          <!-- Casa -->
          <mat-form-field appearance="outline">
            <mat-label>Casa</mat-label>
            <mat-select formControlName="casa_id">
              <mat-option value="">Todas</mat-option>
              <mat-option *ngFor="let casa of casas" [value]="casa.id">
                {{ casa.nombre }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>
      
      <div class="botones-container">
        <button mat-raised-button color="primary" type="button" (click)="buscarTrabajadores()">
          <mat-icon>search</mat-icon> Buscar Trabajadores
        </button>
        
        <button mat-raised-button type="button" (click)="limpiarFiltros()">
          <mat-icon>clear</mat-icon> Limpiar Filtros
        </button>
        
        <button mat-raised-button color="accent" type="button" 
                [disabled]="!trabajadoresSeleccionados.length" 
                (click)="abrirDialogoAsignacion()">
          <mat-icon>add_circle</mat-icon> Asignar Descuentos
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>

<!-- Mensaje de error -->
<div *ngIf="mensajeError" class="mensaje-error">
  <mat-icon>error</mat-icon> {{ mensajeError }}
</div>

<!-- Indicador de carga -->
<div *ngIf="cargando" class="cargando-container">
  <mat-spinner diameter="40"></mat-spinner>
  <p>Procesando información...</p>
</div>

<!-- Resultados de búsqueda -->
<div *ngIf="resultadosExisten && !cargando" class="tabla-resultados">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        Trabajadores Encontrados
        <span *ngIf="trabajadoresSeleccionados.length > 0" class="badge-seleccionados">
          {{ trabajadoresSeleccionados.length }} seleccionado(s)
        </span>
      </mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <div class="tabla-container">
        <table mat-table [dataSource]="trabajadores" class="mat-elevation-z4">
          <!-- Columna Seleccionar -->
          <ng-container matColumnDef="seleccionar">
            <th mat-header-cell *matHeaderCellDef>
              <mat-checkbox (change)="seleccionarTodos($event)"></mat-checkbox>
            </th>
            <td mat-cell *matCellDef="let trabajador">
              <mat-checkbox 
                [checked]="trabajador.seleccionado" 
                (change)="toggleSeleccion(trabajador)">
              </mat-checkbox>
            </td>
          </ng-container>
          
          <!-- Columna Trabajador -->
          <ng-container matColumnDef="trabajador">
            <th mat-header-cell *matHeaderCellDef>Trabajador</th>
            <td mat-cell *matCellDef="let trabajador">{{ trabajador.nombre_completo }}</td>
          </ng-container>
          
          <!-- Columna RUT -->
          <ng-container matColumnDef="rut">
            <th mat-header-cell *matHeaderCellDef>RUT</th>
            <td mat-cell *matCellDef="let trabajador">{{ trabajador.rut }}</td>
          </ng-container>
          
          <!-- Columna Descuentos -->
          <ng-container matColumnDef="descuentos">
            <th mat-header-cell *matHeaderCellDef>Descuentos</th>
            <td mat-cell *matCellDef="let trabajador">
              <div class="chip-container">
                <mat-chip-set *ngIf="getTotalDescuentos(trabajador) > 0">
                  <mat-chip color="warn" selected>
                    {{ getTotalDescuentos(trabajador) }}
                  </mat-chip>
                </mat-chip-set>
                <span *ngIf="getTotalDescuentos(trabajador) === 0" class="sin-datos">
                  Sin descuentos
                </span>
              </div>
            </td>
          </ng-container>
          
          <!-- Columna Acciones -->
          <ng-container matColumnDef="acciones">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let trabajador">
              <button mat-icon-button color="primary" 
                      (click)="verDetallesTrabajador(trabajador)"
                      matTooltip="Ver detalles de descuentos">
                <mat-icon>visibility</mat-icon>
              </button>
            </td>
          </ng-container>
          
          <!-- Definición de filas -->
          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
              [ngClass]="{'fila-seleccionada': row.seleccionado}"
              (click)="toggleSeleccion(row)"></tr>
        </table>
      </div>
      
      <!-- Mensaje cuando no hay resultados -->
      <div *ngIf="trabajadores.length === 0" class="sin-resultados">
        <mat-icon>info</mat-icon>
        <p>No se encontraron trabajadores con los filtros seleccionados.</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>