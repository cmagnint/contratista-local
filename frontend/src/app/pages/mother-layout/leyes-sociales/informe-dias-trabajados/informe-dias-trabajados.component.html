<!--informe-dias-trabajados.component.html-->

<mat-card class="filtros-card">
  <mat-card-header>
    <mat-card-title>Informe de Días Trabajados</mat-card-title>
  </mat-card-header>
  
  <mat-card-content>
    <!-- Banner de mes cerrado -->
    <div *ngIf="mesCerrado" class="mes-cerrado-banner">
      <mat-icon>lock</mat-icon>
      <span class="mes-cerrado-titulo">MES CERRADO</span>
      <span *ngIf="mesCerradoData?.fecha_cierre" class="mes-cerrado-info">
        Cerrado el: {{ mesCerradoData?.fecha_cierre | date:'dd/MM/yyyy HH:mm' }}
      </span>
      <span *ngIf="mesCerradoData?.usuario_cierre_nombre" class="mes-cerrado-info">
        Por: {{ mesCerradoData?.usuario_cierre_nombre }}
      </span>
      <span *ngIf="mesCerradoData?.motivo" class="mes-cerrado-motivo">
        Motivo: {{ mesCerradoData?.motivo }}
      </span>
      
      <!-- Botón para abrir el mes (solo visible si tiene permisos) -->
      <button mat-raised-button color="warn" 
              *ngIf="permisoCerrarMes" 
              (click)="abrirMes()" 
              class="abrir-mes-btn">
        <mat-icon>lock_open</mat-icon> Abrir Mes
      </button>
    </div>

    <form [formGroup]="filtroForm" (ngSubmit)="generarInforme()">
      <div class="filtros-container">
        <div class="filtros-fila">
          <!-- Período (Mes y Año) -->
          <mat-form-field appearance="outline">
            <mat-label>Mes</mat-label>
            <mat-select formControlName="mes">
              <mat-option *ngFor="let mes of meses" [value]="mes.valor">
                {{ mes.nombre }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="filtroForm.get('mes')?.invalid">El mes es requerido</mat-error>
          </mat-form-field>
          
          <mat-form-field appearance="outline">
            <mat-label>Año</mat-label>
            <mat-select formControlName="year">
              <mat-option *ngFor="let year of years" [value]="year">
                {{ year }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="filtroForm.get('year')?.invalid">El año es requerido</mat-error>
          </mat-form-field>
        </div>
        
        <div class="filtros-fila">
          <!-- Filtros adicionales -->
          <mat-form-field appearance="outline">
            <mat-label>Cliente</mat-label>
            <mat-select formControlName="cliente_id">
              <mat-option value="">Todos</mat-option>
              <mat-option *ngFor="let cliente of clientes" [value]="cliente.id">
                {{ cliente.nombre }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          
          <mat-form-field appearance="outline">
            <mat-label>Fundo</mat-label>
            <mat-select formControlName="fundo_id">
              <mat-option value="">Todos</mat-option>
              <mat-option *ngFor="let fundo of fundos" [value]="fundo.id">
                {{ fundo.nombre_campo }}
              </mat-option>
            </mat-select>
            <mat-hint *ngIf="cargandoFundos">Cargando fundos...</mat-hint>
            <mat-hint *ngIf="!filtroForm.get('cliente_id')?.value && !cargandoFundos">
              Seleccione un cliente primero
            </mat-hint>
          </mat-form-field>
        </div>
        
        <div class="filtros-fila">
          <mat-form-field appearance="outline">
            <mat-label>Casa</mat-label>
            <mat-select formControlName="casa_id">
              <mat-option value="">Todas</mat-option>
              <mat-option *ngFor="let casa of casas" [value]="casa.id">
                {{ casa.nombre }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>
      
      <div class="botones-container">
        <button mat-raised-button color="primary" type="submit" [disabled]="filtroForm.invalid || cargando">
          <mat-icon>search</mat-icon> Generar Informe
        </button>
        
        <!-- Botón de Reducción por Cliente (deshabilitado si el mes está cerrado) -->
        <button mat-raised-button color="accent" type="button" 
                [disabled]="!informeCargado || mesCerrado" 
                (click)="abrirDialogoReduccion()">
          <mat-icon>remove_circle_outline</mat-icon> Reducción por Cliente
        </button>
        
        <button mat-raised-button type="button" (click)="limpiarFiltros()">
          <mat-icon>clear</mat-icon> Limpiar Filtros
        </button>
        
        <!-- Botón para guardar registros (deshabilitado si el mes está cerrado) -->
        <button mat-raised-button color="primary" type="button" 
                [disabled]="!informeCargado || !hayRegistrosAprobados() || mesCerrado" 
                (click)="guardarRegistrosAprobados()">
          <mat-icon>save</mat-icon> Guardar Registros Aprobados
        </button>
        
        <!-- Nuevo botón para eliminar todos los registros del mes -->
        <button mat-raised-button color="warn" type="button"
                *ngIf="!mesCerrado && informeCargado && registrosAprobadosExistentes.length > 0" 
                (click)="eliminarRegistrosMes()">
          <mat-icon>delete_forever</mat-icon> Borrar Registros del Mes
        </button>
        
        <!-- Botón para cerrar el mes (solo visible si está abierto y tiene permisos) -->
        <button mat-raised-button color="warn" type="button"
                *ngIf="!mesCerrado && permisoCerrarMes && informeCargado"
                (click)="cerrarMes()">
          <mat-icon>lock</mat-icon> Cerrar Mes
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>

<!-- Mensaje de error si existe -->
<div *ngIf="mensajeError" class="mensaje-error">
  <mat-icon>error</mat-icon> {{ mensajeError }}
</div>

<!-- Spinner de carga -->
<div *ngIf="cargando" class="cargando-container">
  <mat-spinner diameter="40"></mat-spinner>
  <p>Generando informe...</p>
</div>

<!-- Tabla de resultados -->
<div *ngIf="informeCargado && !cargando" class="tabla-resultados">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        Informe de Días Trabajados - {{ getNombreMes() }} {{ filtroForm.get('year')?.value }}
        <span *ngIf="mesCerrado" class="badge-mes-cerrado">MES CERRADO</span>
        
        <!-- Badge para mostrar trabajadores con reducciones -->
        <span *ngIf="numTrabajadoresReducidos > 0" class="badge-reducciones" 
              matTooltip="Hay trabajadores con días reducidos">
          <mat-icon>warning</mat-icon> 
          {{ numTrabajadoresReducidos }} trabajador(es) con reducciones
        </span>
      </mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <!-- Leyenda para tipos de reducciones -->
      <div class="leyenda-reducciones">
        <div class="leyenda-item">
          <div class="color-muestra reduccion-automatica"></div>
          <span>Reducción automática</span>
        </div>
        <div class="leyenda-item">
          <div class="color-muestra reduccion-manual"></div>
          <span>Reducción manual</span>
        </div>
        <div class="leyenda-item">
          <div class="color-muestra aprobado-con-reducciones"></div>
          <span>Aprobado con reducciones</span>
        </div>
        <div class="leyenda-item">
          <div class="color-muestra aprobado-normal"></div>
          <span>Aprobado normal</span>
        </div>
      </div>
      
      <div class="tabla-container" [ngClass]="{'read-only-table': mesCerrado}">
        <table mat-table [dataSource]="trabajadoresData" class="informe-table">
          <!-- Columna Trabajador -->
          <ng-container matColumnDef="trabajador">
            <th mat-header-cell *matHeaderCellDef>Trabajador</th>
            <td mat-cell *matCellDef="let trabajador" [class.registrado-en-db]="trabajador.registrado_en_db">
              {{ getNombreTrabajador(trabajador) }}
              <mat-icon *ngIf="trabajadorTieneReducciones(trabajador)" 
                      class="icono-reducciones"
                      matTooltip="Este trabajador tiene reducciones aplicadas">
                warning
              </mat-icon>
            </td>
            <td mat-footer-cell *matFooterCellDef><strong>Total</strong></td>
          </ng-container>
          
          <!-- Columna RUT -->
          <ng-container matColumnDef="rut">
            <th mat-header-cell *matHeaderCellDef>RUT</th>
            <td mat-cell *matCellDef="let trabajador">{{ trabajador.rut }}</td>
            <td mat-footer-cell *matFooterCellDef></td>
          </ng-container>
          
          <!-- Columna Fecha Ingreso -->
          <ng-container matColumnDef="fecha_ingreso">
            <th mat-header-cell *matHeaderCellDef>Fecha Ingreso</th>
            <td mat-cell *matCellDef="let trabajador">{{ formatFechaIngreso(trabajador.fecha_ingreso) }}</td>
            <td mat-footer-cell *matFooterCellDef></td>
          </ng-container>
          
          <!-- Columnas Dinámicas por Cliente -->
          <ng-container *ngFor="let cliente of clientesData" [matColumnDef]="'cliente_' + cliente.id">
            <th mat-header-cell *matHeaderCellDef>{{ cliente.nombre }}</th>
            <!-- Dentro de la celda de la tabla para días por cliente -->
            <td mat-cell *matCellDef="let trabajador" class="celda-editable" 
            [ngClass]="{
              'reduccion-manual': isValorReducido(trabajador, cliente.id) && isReduccionManual(trabajador, cliente.id),
              'reduccion-automatica': isValorReducido(trabajador, cliente.id) && !isReduccionManual(trabajador, cliente.id)
            }"
            [ngStyle]="getCeldaEstiloReducida(trabajador, cliente.id)"
            [matTooltip]="isValorReducido(trabajador, cliente.id) ? 
                        'Reducido ' + getPorcentajeReduccion(trabajador, cliente.id) + '% ' + 
                        (isReduccionManual(trabajador, cliente.id) ? '(Manual)' : '(Automático)') : ''">
            <input 
            type="number" 
            min="0" 
            [ngModel]="getDiasPorCliente(trabajador, cliente.id)" 
            (ngModelChange)="onDiasChange(trabajador, cliente.id, $event)"
            class="input-dias"
            [disabled]="trabajador.aprobado || mesCerrado">
            <!-- Mostrar siempre valor original cuando hay una reducción o valor editado -->
            <span *ngIf="isValorEditado(trabajador, cliente.id)" class="valor-original">
            [{{ getValorOriginal(trabajador, cliente.id) }}]
            </span>
            <!-- Indicador de reducción aplicada -->
            <div *ngIf="isValorReducido(trabajador, cliente.id)" 
              class="indicador-reduccion"
              [ngClass]="{'reduccion-manual-badge': isReduccionManual(trabajador, cliente.id)}">
            -{{ getPorcentajeReduccion(trabajador, cliente.id) }}%
            </div>
            </td>
            <td mat-footer-cell *matFooterCellDef></td>
          </ng-container>
          
          <!-- Columna Total -->
          <ng-container matColumnDef="total">
            <th mat-header-cell *matHeaderCellDef>Total Días</th>
            <td mat-cell *matCellDef="let trabajador" class="celda-total">{{ getDiasTotales(trabajador) }}</td>
            <td mat-footer-cell *matFooterCellDef></td>
          </ng-container>
          
          <!-- Columna Aprobado -->
          <ng-container matColumnDef="aprobado">
            <th mat-header-cell *matHeaderCellDef>Aprobado</th>
            <td mat-cell *matCellDef="let trabajador" class="celda-aprobado">
              <mat-checkbox 
                [checked]="trabajador.aprobado" 
                (change)="onAprobadoChange(trabajador)"
                color="primary"
                [disabled]="mesCerrado">
              </mat-checkbox>
              <span *ngIf="trabajador.registrado_en_db" class="badge-guardado" 
                    matTooltip="Este registro está guardado en la base de datos">
                <mat-icon>cloud_done</mat-icon>
              </span>
            </td>
            <td mat-footer-cell *matFooterCellDef></td>
          </ng-container>
          
          <!-- Definición de filas de la tabla -->
          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" [ngStyle]="getFilaEstilo(row)"></tr>
          <tr mat-footer-row *matFooterRowDef="displayedColumns; sticky: true"></tr>
        </table>
      </div>
      
      <!-- Mensaje cuando no hay resultados -->
      <div *ngIf="trabajadoresData.length === 0" class="sin-resultados">
        <mat-icon>info</mat-icon>
        <p>No se encontraron resultados para los filtros seleccionados.</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>