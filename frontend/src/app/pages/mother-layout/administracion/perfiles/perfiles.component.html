<!--perfiles.component.html-->
<div class="admin-perfiles-container">
  <button mat-raised-button color="primary" class="custom-button" (click)="openModal('crearPerfil')">CREAR PERFIL</button>
  <button mat-raised-button color="primary" class="custom-button" [disabled]="selectedRows.length !== 1" (click)="openModal('modificarPerfil')">MODIFICAR PERFIL</button>
  <button mat-raised-button color="primary" class="custom-button" [disabled]="isDeleteButtonDisabled()" (click)="openModal('confirmacionModal')">ELIMINAR PERFIL</button>

  <table mat-table [dataSource]="perfiles" class="mat-elevation-z8">
    <ng-container matColumnDef="codigo_perfil">
      <th mat-header-cell *matHeaderCellDef class="mat-header"> C√≥digo </th>
      <td mat-cell *matCellDef="let perfil" class="mat-cell"> {{perfil.id}} </td>
    </ng-container>

    <ng-container matColumnDef="nombre_perfiles">
      <th mat-header-cell *matHeaderCellDef class="mat-header"> Perfiles </th>
      <td mat-cell *matCellDef="let perfil" class="mat-cell"> {{perfil.nombre_perfil}} </td>
    </ng-container>

    <ng-container matColumnDef="tipo">
      <th mat-header-cell *matHeaderCellDef class="mat-header"> Tipo </th>
      <td mat-cell *matCellDef="let perfil" class="mat-cell"> {{perfil.tipo}} </td>
    </ng-container>

    <ng-container matColumnDef="modulos">
      <th mat-header-cell *matHeaderCellDef class="mat-header modulos-column"> M√≥dulos </th>
      <td mat-cell *matCellDef="let perfil" class="mat-cell modulos-column modulos-cell-interactive"> 
        <div class="modulos-interactive-container">
          
          <!-- TIPO WEB -->
          <div *ngIf="(perfil.tipo === 'WEB' || perfil.tipo === 'AMBOS') && getModulosDisplay(perfil).web.length > 0" 
              class="tipo-item-interactive">
            
            <!-- Header del tipo WEB -->
            <div class="tipo-header-interactive web-header" 
                (click)="toggleTipoInTable(perfil.id, 'WEB', $event)"
                [class.expanded]="isTipoExpandedInTable(perfil.id, 'WEB')">
              <div class="tipo-info">
                <span class="expand-icon-table">{{ getExpansionIcon(isTipoExpandedInTable(perfil.id, 'WEB')) }}</span>
                <span class="tipo-icon">üåê</span>
                <span class="tipo-label">WEB</span>
              </div>
              <div class="tipo-counters">
                <span class="counter-badge modules">{{ getModulosCount(getModulosDisplay(perfil).web) }}M</span>
                <span class="counter-badge submodules">{{ getSubmodulosCount(getModulosDisplay(perfil).web) }}S</span>
              </div>
            </div>
            
            <!-- Lista de m√≥dulos WEB -->
            <div class="modulos-list-table" 
                [class.expanded]="isTipoExpandedInTable(perfil.id, 'WEB')">
              
              <div *ngFor="let modulo of getModulosDisplay(perfil).web" 
                  class="modulo-item-interactive">
                
                <!-- Header del m√≥dulo -->
                <div class="modulo-header-interactive"
                    (click)="toggleModuloInTable(perfil.id, 'WEB', modulo.nombre, $event)"
                    [class.expanded]="isModuloExpandedInTable(perfil.id, 'WEB', modulo.nombre)">
                  <div class="modulo-info">
                    <span class="expand-icon-table small" 
                          *ngIf="modulo.submodulos.length > 0">{{ getExpansionIcon(isModuloExpandedInTable(perfil.id, 'WEB', modulo.nombre)) }}</span>
                    <span class="modulo-icon">‚ñ∏</span>
                    <span class="modulo-name">{{ modulo.nombre }}</span>
                  </div>
                  <span class="counter-badge small" 
                        *ngIf="modulo.submodulos.length > 0">{{ modulo.submodulos.length }}</span>
                </div>
                
                <!-- Lista de subm√≥dulos -->
                <div class="submodulos-list-table"
                    [class.expanded]="isModuloExpandedInTable(perfil.id, 'WEB', modulo.nombre)"
                    *ngIf="modulo.submodulos.length > 0">
                  
                  <div *ngFor="let submodulo of modulo.submodulos" 
                      class="submodulo-item-interactive">
                    <span class="submodulo-icon">‚Ä¢</span>
                    <span class="submodulo-name">{{ submodulo.nombre }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- TIPO M√ìVIL -->
          <div *ngIf="(perfil.tipo === 'MOVIL' || perfil.tipo === 'AMBOS') && getModulosDisplay(perfil).movil.length > 0" 
              class="tipo-item-interactive">
            
            <!-- Header del tipo M√ìVIL -->
            <div class="tipo-header-interactive movil-header" 
                (click)="toggleTipoInTable(perfil.id, 'MOVIL', $event)"
                [class.expanded]="isTipoExpandedInTable(perfil.id, 'MOVIL')">
              <div class="tipo-info">
                <span class="expand-icon-table">{{ getExpansionIcon(isTipoExpandedInTable(perfil.id, 'MOVIL')) }}</span>
                <span class="tipo-icon">üì±</span>
                <span class="tipo-label">M√ìVIL</span>
              </div>
              <div class="tipo-counters">
                <span class="counter-badge modules">{{ getModulosCount(getModulosDisplay(perfil).movil) }}M</span>
                <span class="counter-badge submodules">{{ getSubmodulosCount(getModulosDisplay(perfil).movil) }}S</span>
              </div>
            </div>
            
            <!-- Lista de m√≥dulos M√ìVIL -->
            <div class="modulos-list-table" 
                [class.expanded]="isTipoExpandedInTable(perfil.id, 'MOVIL')">
              
              <div *ngFor="let modulo of getModulosDisplay(perfil).movil" 
                  class="modulo-item-interactive">
                
                <!-- Header del m√≥dulo -->
                <div class="modulo-header-interactive"
                    (click)="toggleModuloInTable(perfil.id, 'MOVIL', modulo.nombre, $event)"
                    [class.expanded]="isModuloExpandedInTable(perfil.id, 'MOVIL', modulo.nombre)">
                  <div class="modulo-info">
                    <span class="expand-icon-table small" 
                          *ngIf="modulo.submodulos.length > 0">{{ getExpansionIcon(isModuloExpandedInTable(perfil.id, 'MOVIL', modulo.nombre)) }}</span>
                    <span class="modulo-icon">‚ñ∏</span>
                    <span class="modulo-name">{{ modulo.nombre }}</span>
                  </div>
                  <span class="counter-badge small" 
                        *ngIf="modulo.submodulos.length > 0">{{ modulo.submodulos.length }}</span>
                </div>
                
                <!-- Lista de subm√≥dulos -->
                <div class="submodulos-list-table"
                    [class.expanded]="isModuloExpandedInTable(perfil.id, 'MOVIL', modulo.nombre)"
                    *ngIf="modulo.submodulos.length > 0">
                  
                  <div *ngFor="let submodulo of modulo.submodulos" 
                      class="submodulo-item-interactive">
                    <span class="submodulo-icon">‚Ä¢</span>
                    <span class="submodulo-name">{{ submodulo.nombre }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Mensaje cuando no hay m√≥dulos -->
          <div *ngIf="getModulosDisplay(perfil).web.length === 0 && getModulosDisplay(perfil).movil.length === 0" 
              class="no-modules-interactive">
            <span class="no-modules-icon">‚ö†Ô∏è</span>
            <span>No hay m√≥dulos disponibles</span>
          </div>
          
        </div>
      </td>
    </ng-container>
    
    <ng-container matColumnDef="estado">
      <th mat-header-cell *matHeaderCellDef class="mat-header"> Estado </th>
      <td mat-cell *matCellDef="let perfil" class="mat-cell"> 
        <mat-slide-toggle [checked]="perfil.estado" (change)="toggleEstado(perfil)" [disabled]="isRestrictedNameProfile(perfil)">
          {{ perfil.estado ? 'Activo' : 'Inactivo' }}
        </mat-slide-toggle>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="columnasDesplegadas"></tr>
    <tr mat-row *matRowDef="let row; columns: columnasDesplegadas;" 
        [class.selected]="isSelected(row)"
        [class.admin-principal]="isAdminPrincipal(row)"
        (click)="selectRow(row)">
    </tr>
  </table>
</div>

<div class="modal" *ngIf="modals['crearPerfil'] || modals['modificarPerfil']">
  <div class="modal-content">
    <div class="modal-section">
      <h2>{{ modals['crearPerfil'] ? 'CREAR' : 'MODIFICAR' }} PERFIL</h2>
      <input type="text" 
             class="input-perfil" 
             id="nombrePerfil" 
             placeholder="Nombre del perfil" 
             name="nombrePerfil" 
             [(ngModel)]="nombrePerfil" 
             (ngModelChange)="nombrePerfil = $event.toUpperCase()"
             [disabled]="!modals['crearPerfil'] && isRestrictedNameProfile(selectedRows[0])">
      <select [(ngModel)]="tipoPerfil" (change)="onTipoPerfilChange()">
        <option value="WEB">Web</option>
        <option value="MOVIL">M√≥vil</option>
        <option value="AMBOS">Ambos</option>
      </select>
    </div>
    
    <div class="modal-section" *ngIf="tipoPerfil !== 'MOVIL'">
      <h3>M√ìDULOS WEB</h3>
      <div class="modulos-container-jerarquico">
        
        <!-- Tipo WEB -->
        <div class="tipo-section">
          <div class="tipo-header" [class.active]="isTipoOpen('WEB')" (click)="toggleTipo('WEB')">
            <div class="tipo-header-content">
              <span class="expand-icon" [class.expanded]="isTipoOpen('WEB')">‚ñ∂</span>
              <span class="tipo-label">WEB</span>
              <span class="tipo-badge">Plataforma Web</span>
            </div>
            <span class="selection-counter">{{ getContador('WEB') }}</span>
          </div>
          
          <div class="modulos-list" [class.show]="isTipoOpen('WEB')">
            <div *ngFor="let modulo of modulos_web" class="modulo-item">
              <div class="modulo-header" 
                  [class.selected]="selectedModulosWeb.includes(modulo.id)"
                  (click)="toggleModuloDropdown('WEB', modulo.id)">
                <div class="modulo-header-content">
                  <div class="checkbox-container">
                    <input type="checkbox" 
                          class="custom-checkbox"
                          [checked]="selectedModulosWeb.includes(modulo.id)"
                          (change)="toggleModuloSelection(modulo.id, 'WEB'); $event.stopPropagation()">
                  </div>
                  <span class="expand-icon" [class.expanded]="isModuloDropdownOpen('WEB', modulo.id)">‚ñ∂</span>
                  <span class="modulo-label">{{ modulo.nombre }}</span>
                </div>
                <span class="selection-counter">{{ getContador('WEB_' + modulo.id) }}</span>
              </div>
              
              <div class="submodulos-list" [class.show]="isModuloDropdownOpen('WEB', modulo.id)">
                <div *ngFor="let submodulo of getSubmodulos(modulo.id, 'WEB')" 
                    class="submodulo-item"
                    [class.selected]="selectedSubmodulosWeb.includes(submodulo.id)"
                    (click)="toggleSubmoduloSelection(submodulo.id, modulo.id, 'WEB')">
                  <div class="checkbox-container">
                    <input type="checkbox" 
                          class="custom-checkbox"
                          [checked]="selectedSubmodulosWeb.includes(submodulo.id)"
                          (change)="$event.stopPropagation()">
                  </div>
                  <span class="submodulo-label">{{ submodulo.nombre }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-section" *ngIf="tipoPerfil !== 'WEB'">
      <h3>M√ìDULOS M√ìVIL</h3>
      <div class="modulos-container-jerarquico">
        
        <!-- Tipo MOVIL -->
        <div class="tipo-section">
          <div class="tipo-header" [class.active]="isTipoOpen('MOVIL')" (click)="toggleTipo('MOVIL')">
            <div class="tipo-header-content">
              <span class="expand-icon" [class.expanded]="isTipoOpen('MOVIL')">‚ñ∂</span>
              <span class="tipo-label">M√ìVIL</span>
              <span class="tipo-badge">Aplicaci√≥n M√≥vil</span>
            </div>
            <span class="selection-counter">{{ getContador('MOVIL') }}</span>
          </div>
          
          <div class="modulos-list" [class.show]="isTipoOpen('MOVIL')">
            <div *ngFor="let modulo of modulos_movil" class="modulo-item">
              <div class="modulo-header" 
                  [class.selected]="selectedModulosMovil.includes(modulo.id)"
                  (click)="toggleModuloDropdown('MOVIL', modulo.id)">
                <div class="modulo-header-content">
                  <div class="checkbox-container">
                    <input type="checkbox" 
                          class="custom-checkbox"
                          [checked]="selectedModulosMovil.includes(modulo.id)"
                          (change)="toggleModuloSelection(modulo.id, 'MOVIL'); $event.stopPropagation()">
                  </div>
                  <span class="expand-icon" [class.expanded]="isModuloDropdownOpen('MOVIL', modulo.id)">‚ñ∂</span>
                  <span class="modulo-label">{{ modulo.nombre }}</span>
                </div>
                <span class="selection-counter">{{ getContador('MOVIL_' + modulo.id) }}</span>
              </div>
              
              <div class="submodulos-list" [class.show]="isModuloDropdownOpen('MOVIL', modulo.id)">
                <div *ngFor="let submodulo of getSubmodulos(modulo.id, 'MOVIL')" 
                    class="submodulo-item"
                    [class.selected]="selectedSubmodulosMovil.includes(submodulo.id)"
                    (click)="toggleSubmoduloSelection(submodulo.id, modulo.id, 'MOVIL')">
                  <div class="checkbox-container">
                    <input type="checkbox" 
                          class="custom-checkbox"
                          [checked]="selectedSubmodulosMovil.includes(submodulo.id)"
                          (change)="$event.stopPropagation()">
                  </div>
                  <span class="submodulo-label">{{ submodulo.nombre }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="button-container">
      <button (click)="modals['crearPerfil'] ? agregarPerfil() : modificarPerfil()">
        {{ modals['crearPerfil'] ? 'Crear' : 'Modificar' }}
      </button>
      <button (click)="closeModal(modals['crearPerfil'] ? 'crearPerfil' : 'modificarPerfil')">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal de √©xito -->
<div class="modal" *ngIf="modals['exitoModal']">
  <div class="modal-content">
    <h2>¬°√âxito!</h2>
    <p>La operaci√≥n se ha completado exitosamente.</p>
    <button (click)="closeModal('exitoModal')">Cerrar</button>
  </div>
</div>

<!-- Modal de error -->
<div class="modal" *ngIf="modals['errorModal']">
  <div class="modal-content">
    <h2>Error</h2>
    <p>{{ errorMessage }}</p>
    <button (click)="closeModal('errorModal')">Cerrar</button>
  </div>
</div>

<!-- Modal de confirmaci√≥n -->
<div id="confirmacionModal" class="modal-perfiles" *ngIf="modals['confirmacionModal']">
  <div class="modal-content">
    <p style="color:black; font-weight: 500;">¬øEst√° seguro que desea eliminar el(los) usuario(s) seleccionado(s)?</p>
    <div class="modal-actions">
      <button class="custom-button-yes-button" (click)="eliminarPerfilesSeleccionados()">S√≠</button>
      <button class="custom-button-no-button" (click)="closeModal('confirmacionModal')">No</button>
    </div>
  </div>
</div>