<!-- Título del módulo -->
<div class="header-container">
  <h1 class="page-title">
    <mat-icon>receipt_long</mat-icon>
    Facturas Venta SII Distribuidas
  </h1>
  <p class="page-subtitle">Consulte y gestione las facturas que ya han sido distribuidas</p>
</div>

<!-- Tarjeta de filtros -->
<mat-card class="filtros-card">
  <mat-card-header>
    <mat-card-title>
      <mat-icon>filter_list</mat-icon>
      Filtros de Búsqueda
    </mat-card-title>
  </mat-card-header>
  
  <mat-card-content>
    <form [formGroup]="filtrosForm" class="filtros-form">
      <!-- Primera fila de filtros -->
      <div class="filtros-row">
        <mat-form-field appearance="outline" class="filtro-field">
          <mat-label>Cliente</mat-label>
          <mat-select formControlName="cliente_id" (selectionChange)="onClienteSeleccionado()">
            <mat-option value="">Todos los clientes</mat-option>
            <mat-option *ngFor="let cliente of clientes" [value]="cliente.id">
              {{ cliente.nombre }} ({{ cliente.rut }})
            </mat-option>
          </mat-select>
          <mat-icon matSuffix>person</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filtro-field">
          <mat-label>Fundo/Campo</mat-label>
          <mat-select formControlName="fundo_id" [disabled]="!filtrosForm.get('cliente_id')?.value">
            <mat-option value="">Todos los fundos</mat-option>
            <mat-option *ngFor="let fundo of fundos" [value]="fundo.id">
              {{ fundo.nombre_campo }}
            </mat-option>
          </mat-select>
          <mat-icon matSuffix>landscape</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filtro-field">
          <mat-label>Labor</mat-label>
          <mat-select formControlName="labor_id">
            <mat-option value="">Todas las labores</mat-option>
            <mat-option *ngFor="let labor of labores" [value]="labor.id">
              {{ labor.nombre }} ({{ labor.especie }})
            </mat-option>
          </mat-select>
          <mat-icon matSuffix>work</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filtro-field">
          <mat-label>Cuenta</mat-label>
          <mat-select formControlName="cuenta_id">
            <mat-option value="">Todas las cuentas</mat-option>
            <mat-option *ngFor="let cuenta of cuentas" [value]="cuenta.id">
              {{ cuenta.nombre_cuenta }} ({{ cuenta.cuenta_contable }})
            </mat-option>
          </mat-select>
          <mat-icon matSuffix>account_balance</mat-icon>
        </mat-form-field>
      </div>

      <!-- Segunda fila de filtros -->
      <div class="filtros-row">
        <mat-form-field appearance="outline" class="filtro-field">
          <mat-label>Fecha Desde</mat-label>
          <input matInput type="date" formControlName="fecha_desde">
          <mat-icon matSuffix>calendar_today</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filtro-field">
          <mat-label>Fecha Hasta</mat-label>
          <input matInput type="date" formControlName="fecha_hasta">
          <mat-icon matSuffix>calendar_today</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filtro-field">
          <mat-label>Folio</mat-label>
          <input matInput formControlName="folio" placeholder="Buscar por folio">
          <mat-icon matSuffix>confirmation_number</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filtro-field">
          <mat-label>Receptor</mat-label>
          <input matInput formControlName="razon_social" placeholder="Buscar por razón social">
          <mat-icon matSuffix>business</mat-icon>
        </mat-form-field>
      </div>
    </form>
  </mat-card-content>

  <mat-card-actions class="filtros-actions">
    <button mat-raised-button color="primary" (click)="aplicarFiltros()" [disabled]="loading">
      <mat-icon>search</mat-icon>
      Buscar
    </button>
    <button mat-stroked-button (click)="limpiarFiltros()" [disabled]="loading">
      <mat-icon>clear</mat-icon>
      Limpiar Filtros
    </button>
  </mat-card-actions>
</mat-card>

<!-- Barra de progreso -->
<mat-progress-bar mode="indeterminate" *ngIf="loading" class="loading-bar"></mat-progress-bar>

<!-- Mensaje de error -->
<mat-card *ngIf="error" class="error-card">
  <mat-card-content>
    <div class="error-content">
      <mat-icon color="warn">error</mat-icon>
      <span>{{ error }}</span>
    </div>
  </mat-card-content>
  <mat-card-actions>
    <button mat-button color="primary" (click)="cargarFacturasDistribuidas()">
      <mat-icon>refresh</mat-icon>
      Reintentar
    </button>
  </mat-card-actions>
</mat-card>

<!-- Información de resumen -->
<div class="resumen-container" *ngIf="!loading && !error">
  <mat-card class="resumen-card">
    <mat-card-content>
      <div class="resumen-stats">
        <div class="stat-item">
          <mat-icon class="stat-icon">receipt</mat-icon>
          <div class="stat-info">
            <span class="stat-value">{{ totalItems }}</span>
            <span class="stat-label">Facturas Únicas</span>
          </div>
        </div>
        
        <div class="stat-item">
          <mat-icon class="stat-icon" [class.selected]="getCantidadSeleccionada() > 0">check_circle</mat-icon>
          <div class="stat-info">
            <span class="stat-value" [class.selected]="getCantidadSeleccionada() > 0">{{ getCantidadSeleccionada() }}</span>
            <span class="stat-label">Seleccionadas</span>
          </div>
        </div>
        
        <div class="stat-item">
          <mat-icon class="stat-icon" [class.selected]="getTotalDistribucionesSeleccionadas() > 0">account_tree</mat-icon>
          <div class="stat-info">
            <span class="stat-value" [class.selected]="getTotalDistribucionesSeleccionadas() > 0">{{ getTotalDistribucionesSeleccionadas() }}</span>
            <span class="stat-label">Distribuciones</span>
          </div>
        </div>
        
        <div class="stat-item">
          <mat-icon class="stat-icon" [class.selected]="getTotalSeleccionado() > 0">attach_money</mat-icon>
          <div class="stat-info">
            <span class="stat-value" [class.selected]="getTotalSeleccionado() > 0">{{ formatearMonto(getTotalSeleccionado()) }}</span>
            <span class="stat-label">Monto Seleccionado</span>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Botones de acción -->
  <div class="acciones-container">
    <button 
      mat-stroked-button 
      color="primary" 
      (click)="expandirTodas()" 
      [disabled]="facturasParaMostrar.length === 0"
      matTooltip="Expandir todas las facturas para ver distribuciones">
      <mat-icon>expand_more</mat-icon>
      Expandir Todas
    </button>
    
    <button 
      mat-stroked-button 
      color="primary" 
      (click)="colapsarTodas()" 
      [disabled]="facturasParaMostrar.length === 0"
      matTooltip="Colapsar todas las facturas">
      <mat-icon>expand_less</mat-icon>
      Colapsar Todas
    </button>
    
    <button 
      mat-raised-button 
      color="accent" 
      (click)="descargarCSV()" 
      [disabled]="getCantidadSeleccionada() === 0 || loadingExport"
      matTooltip="Descargar facturas seleccionadas en formato CSV">
      <mat-icon>download</mat-icon>
      Descargar CSV
      <mat-progress-spinner 
        *ngIf="loadingExport" 
        diameter="20" 
        mode="indeterminate"
        color="accent">
      </mat-progress-spinner>
    </button>
  </div>
</div>

<!-- Tabla de facturas -->
<mat-card class="table-card" *ngIf="!loading && !error">
  <mat-card-header>
    <mat-card-title>
      <mat-icon>table_view</mat-icon>
      Facturas Distribuidas
      <span class="subtitle-info" *ngIf="totalItems > 0">
        ({{ totalItems }} facturas únicas)
      </span>
    </mat-card-title>
  </mat-card-header>

  <mat-card-content>
    <div class="table-container">
      <!-- Tabla principal con clases específicas aplicadas -->
      <table mat-table 
             [dataSource]="facturasParaMostrar" 
             matSort 
             (matSortChange)="onSortChange($event)" 
             class="facturas-table">
        
        <!-- Columna de selección - CORREGIDA -->
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef class="mat-column-select select-column">
            <mat-checkbox 
              [checked]="allSelected"
              [indeterminate]="someSelected"
              (change)="onSelectAll()"
              matTooltip="Seleccionar todas">
            </mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let factura" class="mat-column-select select-column">
            <mat-checkbox 
              [checked]="factura.selected"
              (change)="onFacturaSeleccionada(factura)">
            </mat-checkbox>
          </td>
        </ng-container>

        <!-- Columna de expansión - CORREGIDA -->
        <ng-container matColumnDef="expand">
          <th mat-header-cell *matHeaderCellDef class="mat-column-expand expand-column">
            <mat-icon matTooltip="Expandir/Colapsar">unfold_more</mat-icon>
          </th>
          <td mat-cell *matCellDef="let factura" class="mat-column-expand expand-column">
            <button 
              mat-icon-button 
              (click)="toggleExpansion(factura); $event.stopPropagation()"
              [disabled]="factura.cantidad_distribuciones <= 1"
              [matTooltip]="factura.cantidad_distribuciones > 1 ? (factura.expanded ? 'Colapsar distribuciones' : 'Ver distribuciones (' + factura.cantidad_distribuciones + ')') : 'Una sola distribución'"
              class="expand-button">
              <mat-icon [class.expanded]="factura.expanded">
                {{ factura.cantidad_distribuciones > 1 ? (factura.expanded ? 'expand_less' : 'expand_more') : 'fiber_manual_record' }}
              </mat-icon>
            </button>
          </td>
        </ng-container>

        <!-- Folio - CORREGIDA -->
        <ng-container matColumnDef="folio">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="mat-column-folio">
            Folio
          </th>
          <td mat-cell *matCellDef="let factura" class="mat-column-folio">
            <div class="folio-container">
              <span class="folio-badge">{{ factura.folio }}</span>
              <span class="distribuciones-badge" *ngIf="factura.cantidad_distribuciones > 1">
                {{ factura.cantidad_distribuciones }} distribuciones
              </span>
            </div>
          </td>
        </ng-container>

        <!-- Tipo Documento - CORREGIDA -->
        <ng-container matColumnDef="tipo_doc">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="mat-column-tipo_doc">
            Tipo Doc
          </th>
          <td mat-cell *matCellDef="let factura" class="mat-column-tipo_doc">
            <mat-chip class="tipo-doc-chip">{{ factura.tipo_doc }}</mat-chip>
          </td>
        </ng-container>

        <!-- Fecha Documento - CORREGIDA -->
        <ng-container matColumnDef="fecha_docto">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="mat-column-fecha_docto">
            Fecha Doc
          </th>
          <td mat-cell *matCellDef="let factura" class="mat-column-fecha_docto">
            <span class="fecha">{{ formatearFecha(factura.fecha_docto) }}</span>
          </td>
        </ng-container>

        <!-- Proveedor - CORREGIDA -->
        <ng-container matColumnDef="razon_social">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="mat-column-razon_social">
            Proveedor
          </th>
          <td mat-cell *matCellDef="let factura" class="mat-column-razon_social proveedor-cell">
            <div class="proveedor-info">
              <span class="proveedor-nombre">{{ factura.razon_social }}</span>
              <span class="proveedor-rut">{{ factura.rut_proveedor }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Monto Total Original - CORREGIDA -->
        <ng-container matColumnDef="monto_total_original">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="mat-column-monto_total_original">
            Monto Original
          </th>
          <td mat-cell *matCellDef="let factura" class="mat-column-monto_total_original monto-cell">
            <span class="monto-value">{{ formatearMonto(factura.monto_total_original) }}</span>
          </td>
        </ng-container>

        <!-- Monto Total Distribuido - CORREGIDA -->
        <ng-container matColumnDef="monto_total_distribuido">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="mat-column-monto_total_distribuido">
            Monto Distribuido
          </th>
          <td mat-cell *matCellDef="let factura" class="mat-column-monto_total_distribuido monto-cell distribuido">
            <span class="monto-value">{{ formatearMonto(factura.monto_total_distribuido) }}</span>
          </td>
        </ng-container>

        <!-- Cantidad de distribuciones - CORREGIDA -->
        <ng-container matColumnDef="cantidad_distribuciones">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="mat-column-cantidad_distribuciones">
            Distribuciones
          </th>
          <td mat-cell *matCellDef="let factura" class="mat-column-cantidad_distribuciones distribuciones-count-cell">
            <div class="distribuciones-count">
              <mat-icon class="distribuciones-icon">account_tree</mat-icon>
              <span class="count">{{ factura.cantidad_distribuciones }}</span>
              <span class="count-label">{{ factura.cantidad_distribuciones === 1 ? 'cliente' : 'clientes' }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Fecha Primera Distribución - CORREGIDA -->
        <ng-container matColumnDef="fecha_primera_distribucion">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="mat-column-fecha_primera_distribucion">
            Primera Distribución
          </th>
          <td mat-cell *matCellDef="let factura" class="mat-column-fecha_primera_distribucion">
            <span class="fecha">{{ formatearFecha(factura.fecha_primera_distribucion) }}</span>
          </td>
        </ng-container>

        <!-- Acciones - CORREGIDA -->
        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef class="mat-column-acciones">
            Acciones
          </th>
          <td mat-cell *matCellDef="let factura" class="mat-column-acciones">
            <button 
              mat-icon-button 
              color="primary"
              matTooltip="Ver detalles de la factura"
              (click)="$event.stopPropagation()">
              <mat-icon>visibility</mat-icon>
            </button>
          </td>
        </ng-container>

        <!-- Encabezados y filas con clases específicas -->
        <tr mat-header-row *matHeaderRowDef="displayedColumns" class="mat-header-row"></tr>
        <tr mat-row 
            *matRowDef="let row; columns: displayedColumns;" 
            class="mat-row factura-row"
            [class.has-distributions]="row.cantidad_distribuciones > 1"
            [class.expanded]="row.expanded"
            [class.selected]="row.selected"
            (click)="toggleExpansion(row)">
        </tr>
      </table>

      <!-- Sección de distribuciones expandidas -->
      <div class="distribuciones-section" *ngFor="let factura of facturasParaMostrar">
        <div class="expanded-detail-container" 
             *ngIf="factura.expanded && factura.cantidad_distribuciones > 1"
             [@fadeInOut]>
          
          <div class="distribuciones-header">
            <mat-icon>account_tree</mat-icon>
            <h4>Distribuciones de la Factura {{ factura.folio }}</h4>
            <span class="distribuciones-count-header">{{ factura.cantidad_distribuciones }} distribuciones</span>
          </div>
          
          <div class="distribuciones-table-container">
            <table class="distribuciones-table">
              <thead>
                <tr class="distribuciones-header-row">
                  <th>Cliente</th>
                  <th>Fundo</th>
                  <th>Labor</th>
                  <th>Cuenta</th>
                  <th>Monto</th>
                  <th>Fecha</th>
                  <th>Usuario</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let distribucion of factura.distribuciones; let i = index" 
                    class="distribucion-row"
                    [style.animation-delay.ms]="i * 50">
                  
                  <td class="cliente-cell">
                    <div class="cliente-info">
                      <span class="cliente-nombre">{{ distribucion.cliente_nombre }}</span>
                      <span class="cliente-rut">{{ distribucion.cliente_rut }}</span>
                    </div>
                  </td>
                  
                  <td>
                    <span class="fundo-name" *ngIf="distribucion.fundo_nombre">{{ distribucion.fundo_nombre }}</span>
                    <span class="no-data" *ngIf="!distribucion.fundo_nombre">-</span>
                  </td>
                  
                  <td>
                    <span class="labor-name" *ngIf="distribucion.labor_nombre">{{ distribucion.labor_nombre }}</span>
                    <span class="no-data" *ngIf="!distribucion.labor_nombre">-</span>
                  </td>
                  
                  <td class="cuenta-cell">
                    <div class="cuenta-info" *ngIf="distribucion.cuenta_nombre">
                      <span class="cuenta-nombre">{{ distribucion.cuenta_nombre }}</span>
                      <span class="cuenta-codigo">{{ distribucion.cuenta_codigo }}</span>
                    </div>
                    <span class="no-data" *ngIf="!distribucion.cuenta_nombre">-</span>
                  </td>
                  
                  <td class="monto-cell">
                    <span class="monto-value distribucion">{{ formatearMonto(distribucion.monto_total) }}</span>
                  </td>
                  
                  <td>
                    <span class="fecha">{{ formatearFecha(distribucion.fecha_distribucion) }}</span>
                  </td>
                  
                  <td>
                    <span class="usuario">{{ distribucion.usuario_nombre }}</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Mensaje cuando no hay datos -->
      <div class="no-data-container" *ngIf="facturasParaMostrar.length === 0">
        <mat-icon class="no-data-icon">receipt_long</mat-icon>
        <p class="no-data-message">No se encontraron facturas distribuidas con los filtros aplicados</p>
        <button mat-raised-button color="primary" (click)="limpiarFiltros()">
          <mat-icon>refresh</mat-icon>
          Mostrar Todas
        </button>
      </div>
    </div>

    <!-- Paginador -->
    <mat-paginator 
      *ngIf="totalItems > 0"
      [length]="totalItems"
      [pageSize]="pageSize"
      [pageSizeOptions]="pageSizeOptions"
      [pageIndex]="currentPage"
      (page)="onPageChange($event)"
      showFirstLastButtons
      class="table-paginator">
    </mat-paginator>
  </mat-card-content>
</mat-card>